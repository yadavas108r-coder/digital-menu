<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Yadava's Admin</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; background:#f6f7fb; color:#222; }
    header { background:#d23b3b; color:#fff; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { margin:0; font-size:20px; }
    .wrap { padding:20px; max-width:1200px; margin:0 auto; }
    .row { display:flex; gap:20px; margin-bottom:18px; align-items:center; flex-wrap:wrap; }
    .card { background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(12,20,40,0.06); flex:1; min-width:220px; }
    button { background:#2b7aeb; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .muted { color:#666; font-size:13px; }
    .table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(12,20,40,0.06); }
    .table th, .table td { padding:10px 12px; text-align:left; border-bottom:1px solid #eee; }
    .table th { background:#fafafa; }
    .small { font-size:12px; color:#555; }
    .status { padding:6px 10px; border-radius:20px; font-weight:600; }
    .status.pending { background:#fff4e6; color:#aa6b00; }
    .status.preparing { background:#fff1f2; color:#b32424; }
    .status.ready { background:#e8fff0; color:#007a3d; }
    .status.delivered { background:#f0f7ff; color:#004a8f; }
    .form-row { display:flex; gap:8px; align-items:center; }
    input[type="text"], input[type="number"], textarea, select { padding:8px; border-radius:6px; border:1px solid #ddd; }
    .right { margin-left:auto; }
    .danger { background:#ff6b6b; }
  </style>
</head>
<body>
  <header>
    <h1>üçß Yadava's Admin Panel</h1>
    <div id="adminInfo"></div>
  </header>

  <div class="wrap">
    <div class="row">
      <div class="card" style="max-width:320px;">
        <h3>Login (Admin)</h3>
        <div class="muted">Enter admin password to unlock admin controls</div>
        <div style="margin-top:10px;">
          <input id="adminPass" type="password" placeholder="Admin password" />
          <button onclick="adminLogin()">Unlock</button>
        </div>
      </div>

      <div class="card">
        <h3>Quick Stats</h3>
        <div class="row">
          <div>
            <div class="muted">Total Orders</div>
            <div id="statOrders" style="font-size:20px;font-weight:700;">‚Äî</div>
          </div>
          <div>
            <div class="muted">Pending</div>
            <div id="statPending" style="font-size:20px;font-weight:700;color:#d23b3b;">‚Äî</div>
          </div>
          <div>
            <div class="muted">Revenue (Today)</div>
            <div id="statRevenue" style="font-size:20px;font-weight:700;color:#109e63;">‚Çπ ‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card right" style="max-width:300px;">
        <h3>Actions</h3>
        <div style="display:flex;gap:8px;">
          <button onclick="refreshAll()">Refresh</button>
          <button onclick="downloadCSV()" class="right">Export CSV</button>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:20px; flex-wrap:wrap;">
      <div style="flex:1; min-width:420px;">
        <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
          <h3 style="margin:0;">Orders</h3>
          <div class="muted"> (click status to change)</div>
        </div>
        <table class="table" id="ordersTable">
          <thead><tr><th>Time</th><th>Name</th><th>Items</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="ordersTbody"></tbody>
        </table>
      </div>

      <div style="flex:1; min-width:420px;">
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0;">Products</h3>
          <div class="muted"> (add / edit / delete)</div>
          <div class="right"><button onclick="showAddProduct()">+ Add Product</button></div>
        </div>

        <table class="table" id="productsTable">
          <thead><tr><th>Row</th><th>Name</th><th>Price</th><th>Category</th><th>Actions</th></tr></thead>
          <tbody id="productsTbody"></tbody>
        </table>

        <div id="productForm" style="margin-top:12px; display:none;">
          <h4 id="productFormTitle">Add Product</h4>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input id="pName" placeholder="Name" />
            <input id="pPrice" placeholder="Price" type="number" />
            <input id="pImage" placeholder="Image URL" />
          </div>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input id="pCategory" placeholder="Category" />
            <input id="pDescription" placeholder="Description" />
            <select id="pType"><option>Veg</option><option>Non-Veg</option></select>
          </div>
          <div style="display:flex; gap:8px;">
            <button onclick="saveProduct()">Save</button>
            <button onclick="cancelProduct()" class="danger">Cancel</button>
          </div>
        </div>

      </div>
    </div>

    <div style="margin-top:18px;">
      <h3>Categories</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="categoryList"></select>
        <input id="newCategory" placeholder="New category" />
        <button onclick="addCategory()">Add</button>
        <button onclick="deleteCategory()" class="danger">Delete Selected</button>
      </div>
    </div>

    <div style="height:40px;"></div>
  </div>

  <script>
    // ---------- state ----------
    let ADMIN_PASS = null;
    const SHEET_URL = "<?= ScriptApp.getService().getUrl ? ScriptApp.getService().getUrl() : '' ?>";
    // Actually, HtmlService doesn't allow ScriptApp URL directly. Instead call from client to same origin via google.script.run for server actions,
    // but we chose to use doGet JSONP endpoints. So compute endpoint from window.location:
    const BASE_URL = window.location.href.split('?')[0]; // same URL
    const FULL_API = BASE_URL; // append ?action=...&callback=...

    // ---------- util: JSONP caller ----------
    function jsonp(url, cb) {
      const cbName = 'cb_' + Date.now() + Math.floor(Math.random()*9999);
      return new Promise((resolve, reject) => {
        window[cbName] = (res) => { resolve(res); cleanup(); };
        function cleanup(){ try{ delete window[cbName]; const s=document.getElementById(cbName); if(s) s.remove(); }catch(e){} }
        const s = document.createElement('script');
        s.id = cbName;
        s.src = url + (url.indexOf('?')> -1 ? '&' : '?') + 'callback=' + cbName;
        s.onerror = () => { reject(new Error('Network error')); cleanup(); };
        document.body.appendChild(s);
      });
    }

    // ---------- admin login ----------
    function adminLogin(){
      const p = document.getElementById('adminPass').value.trim();
      if(!p){ alert('Enter admin password'); return; }
      ADMIN_PASS = p;
      refreshAll();
      document.getElementById('adminInfo').innerText = 'Admin unlocked';
    }

    // ---------- refresh ----------
    async function refreshAll(){
      try {
        // orders
        const ordersRes = await jsonp(FULL_API + '?action=getOrders');
        if(ordersRes && ordersRes.orders) { renderOrders(ordersRes.orders); computeStats(ordersRes.orders); }

        const prodsRes = await jsonp(FULL_API + '?action=getProducts');
        if(prodsRes && prodsRes.products) { renderProducts(prodsRes.products); populateCategoryDropdown(prodsRes.products); }

      } catch(err){ console.error(err); alert('Failed to refresh: '+err.message); }
    }

    function computeStats(orders){
      document.getElementById('statOrders').innerText = orders.length;
      const pending = orders.filter(o => (o.Status||'Pending').toLowerCase() === 'pending').length;
      document.getElementById('statPending').innerText = pending;
      // revenue today
      const today = new Date().toDateString();
      const revenue = orders.reduce((acc,o) => {
        const t = new Date(o.Timestamp).toDateString();
        if(t === today) return acc + Number(o.Price || o['Total'] || o.Total || 0);
        return acc;
      },0);
      document.getElementById('statRevenue').innerText = '‚Çπ' + (revenue || 0);
    }

    function renderOrders(rows){
      const tbody = document.getElementById('ordersTbody'); tbody.innerHTML='';
      rows.sort((a,b)=> new Date(b.Timestamp) - new Date(a.Timestamp));
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const time = new Date(r.Timestamp).toLocaleString();
        const items = typeof r.Items === 'string' ? r.Items : (r.Items || r['Cart'] || r['items'] || '[]');
        let itemsStr = items;
        try{ const arr = JSON.parse(items); itemsStr = arr.map(it => it.name + ' x' + (it.quantity||1)).join(', '); }catch(e){}
        const total = r.Total || r.Price || r['Amount'] || r.totalAmount || 0;
        const status = r.Status || 'Pending';
        tr.innerHTML = `<td>${time}</td>
          <td><b>${r.Name || r.name || r.Customer || r['Customer Name'] || ''}</b><div class="small">${r.email||r.Email||''}</div></td>
          <td>${itemsStr}</td>
          <td>‚Çπ${total}</td>
          <td><span class="status ${status.toLowerCase()}">${status}</span></td>
          <td>
            <select onchange="changeOrderStatus(${r.__row}, this.value)">
              <option value="Pending">Pending</option>
              <option value="Preparing">Preparing</option>
              <option value="Ready">Ready</option>
              <option value="Delivered">Delivered</option>
              <option value="Cancelled">Cancelled</option>
            </select>
            <button onclick="notifyCustomer(${r.__row})">Notify</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function changeOrderStatus(row, status){
      if(!ADMIN_PASS) { alert('Unlock admin first'); return; }
      try{
        const res = await jsonp(FULL_API + `?action=updateOrder&row=${row}&status=${encodeURIComponent(status)}&admin_pass=${encodeURIComponent(ADMIN_PASS)}`);
        if(res && res.success) { alert('Status updated'); refreshAll(); } else { alert('Update failed: '+(res.error||res.message)); }
      }catch(e){ alert('Network error'); }
    }

    function notifyCustomer(row){
      alert('You can use MailApp within GAS to notify customer automatically. This button is placeholder.');
    }

    // ---------- products ----------
    let editingRow = null;
    function renderProducts(rows){
      const tbody = document.getElementById('productsTbody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.__row}</td><td>${r.Name||r.name||''}</td><td>‚Çπ${r.Price||r.price||''}</td><td>${r.Category||''}</td>
          <td>
            <button onclick='startEdit(${r.__row}, ${JSON.stringify(JSON.stringify(r)).replace(/</g,"\\u003c")})'>Edit</button>
            <button onclick='delProd(${r.__row})' class="danger">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function startEdit(row, jsonStr){
      if(!ADMIN_PASS){ alert('Unlock admin'); return; }
      editingRow = row;
      const r = JSON.parse(JSON.parse(jsonStr));
      document.getElementById('productForm').style.display='block';
      document.getElementById('productFormTitle').innerText='Edit Product (Row '+row+')';
      document.getElementById('pName').value = r.Name || r.name || '';
      document.getElementById('pPrice').value = r.Price || r.price || '';
      document.getElementById('pImage').value = r.Image || r.image || '';
      document.getElementById('pCategory').value = r.Category || r.category || '';
      document.getElementById('pDescription').value = r.Description || r.description || '';
      document.getElementById('pType').value = r.Type || r.type || 'Veg';
    }

    function showAddProduct(){
      if(!ADMIN_PASS){ alert('Unlock admin'); return; }
      editingRow = null;
      document.getElementById('productForm').style.display='block';
      document.getElementById('productFormTitle').innerText='Add Product';
      document.getElementById('pName').value=''; document.getElementById('pPrice').value=''; document.getElementById('pImage').value=''; document.getElementById('pCategory').value=''; document.getElementById('pDescription').value='';
    }

    async function saveProduct(){
      if(!ADMIN_PASS){ alert('Unlock admin'); return; }
      const pd = {
        Name: document.getElementById('pName').value,
        Price: document.getElementById('pPrice').value,
        Image: document.getElementById('pImage').value,
        Category: document.getElementById('pCategory').value,
        Description: document.getElementById('pDescription').value,
        Type: document.getElementById('pType').value
      };
      try{
        if(editingRow){
          const res = await jsonp(FULL_API + `?action=updateProduct&row=${editingRow}&productData=${encodeURIComponent(JSON.stringify(pd))}&admin_pass=${encodeURIComponent(ADMIN_PASS)}`);
          if(res.status==='success'){ alert('Updated'); cancelProduct(); refreshAll(); } else alert(res.error||'Error');
        } else {
          const res = await jsonp(FULL_API + `?action=addProduct&productData=${encodeURIComponent(JSON.stringify(pd))}&admin_pass=${encodeURIComponent(ADMIN_PASS)}`);
          if(res.status==='success'){ alert('Added'); cancelProduct(); refreshAll(); } else alert(res.error||'Error');
        }
      }catch(e){ alert('Network error'); }
    }

    function cancelProduct(){ editingRow=null; document.getElementById('productForm').style.display='none'; }

    async function delProd(row){
      if(!ADMIN_PASS){ alert('Unlock admin'); return; }
      if(!confirm('Delete product at row '+row+'?')) return;
      try{
        const res = await jsonp(FULL_API + `?action=deleteProduct&row=${row}&admin_pass=${encodeURIComponent(ADMIN_PASS)}`);
        if(res.status==='success'){ alert('Deleted'); refreshAll(); } else alert(res.error||'Error');
      }catch(e){ alert('Network error'); }
    }

    // categories
    function populateCategoryDropdown(products){
      const list = document.getElementById('categoryList');
      list.innerHTML = '';
      const cats = [...new Set((products||[]).map(p => p.Category||p.category||'').filter(Boolean))];
      cats.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; list.appendChild(o); });
    }

    async function addCategory(){
      if(!ADMIN_PASS) { alert('Unlock admin'); return; }
      const c = document.getElementById('newCategory').value.trim();
      if(!c) return alert('Enter category');
      try {
        const res = await jsonp(FULL_API + `?action=addCategory&category=${encodeURIComponent(c)}&admin_pass=${encodeURIComponent(ADMIN_PASS)}`);
        if(res.status==='success'){ alert('Category added (use when creating product)'); refreshAll(); } else alert(res.error||'Error');
      } catch(e){ alert('Network error'); }
    }

    async function deleteCategory(){
      if(!ADMIN_PASS){ alert('Unlock admin'); return; }
      const c = document.getElementById('categoryList').value;
      if(!confirm('Clear category references for "'+c+'"? This will blank Category field on products.')) return;
      try {
        const res = await jsonp(FULL_API + `?action=deleteCategory&category=${encodeURIComponent(c)}&admin_pass=${encodeURIComponent(ADMIN_PASS)}`);
        if(res.status==='success'){ alert('Category cleared'); refreshAll(); } else alert(res.error||'Error');
      } catch(e){ alert('Network error'); }
    }

    // export csv simple
    function downloadCSV(){
      // fetch orders then CSV
      jsonp(FULL_API + '?action=getOrders').then(res=>{
        const rows = res.orders || [];
        let csv = 'Timestamp,Name,Table,Items,Total,Review,Email,Status\n';
        rows.forEach(r=> {
          const safe = v => '"' + String(v || '').replace(/"/g,'""') + '"';
          csv += [safe(r.Timestamp), safe(r.Name||r.name), safe(r.Table||r.table), safe(r.Items||r.items), safe(r.Total||r.Price||r.totalAmount), safe(r.Review||r.review), safe(r.Email||r.email), safe(r.Status||'')].join(',') + '\n';
        });
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        a.download = 'orders.csv';
        document.body.appendChild(a); a.click(); a.remove();
      }).catch(e=>alert('Export failed'));
    }

    // ---------- init ----------
    refreshAll();
  </script>
</body>
</html>
